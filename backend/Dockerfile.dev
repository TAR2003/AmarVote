FROM maven:3.9-eclipse-temurin-21

# Update CA certificates and configure Maven
RUN apt-get update && \
    apt-get install -y ca-certificates && \
    update-ca-certificates && \
    mkdir -p /root/.m2 && \
    echo "<settings><mirrors><mirror><id>central-http</id><url>https://repo1.maven.org/maven2</url><mirrorOf>central</mirrorOf></mirror></mirrors></settings>" > /root/.m2/settings.xml

WORKDIR /build
COPY pom.xml .
# Retry logic for flaky connections
RUN mvn -B dependency:resolve || mvn -B dependency:resolve

WORKDIR /app
COPY src/main/resources/application.properties ./src/main/resources/

EXPOSE 8080

CMD ["mvn", "spring-boot:run"]